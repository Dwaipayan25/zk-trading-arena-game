'use strict';

var de = require('gzip-js');
var ye = require('tar-js');
var $ = require('axios');
var Q = require('@fullstax/p-retry');
var zod = require('zod');
var ce = require('pino');

function _interopDefault (e) { return e && e.__esModule ? e : { default: e }; }

var de__default = /*#__PURE__*/_interopDefault(de);
var ye__default = /*#__PURE__*/_interopDefault(ye);
var $__default = /*#__PURE__*/_interopDefault($);
var Q__default = /*#__PURE__*/_interopDefault(Q);
var ce__default = /*#__PURE__*/_interopDefault(ce);

var S=class{constructor(e){this.config=e;}};var T=window.File,P=window.FormData;var I=class extends Error{url;status;statusText;body;request;constructor(e,r,o){super(o),this.name="ApiError",this.url=r.url,this.status=r.status,this.statusText=r.statusText,this.body=r.body,this.request=e;}};var N=class extends Error{constructor(e){super(e),this.name="CancelError";}get isCancelled(){return !0}},A=class{#t;#r;#e;#o;#s;#n;#i;constructor(e){this.#t=!1,this.#r=!1,this.#e=!1,this.#o=[],this.#s=new Promise((r,o)=>{this.#n=r,this.#i=o;let s=p=>{this.#t||this.#r||this.#e||(this.#t=!0,this.#n?.(p));},n=p=>{this.#t||this.#r||this.#e||(this.#r=!0,this.#i?.(p));},i=p=>{this.#t||this.#r||this.#e||this.#o.push(p);};return Object.defineProperty(i,"isResolved",{get:()=>this.#t}),Object.defineProperty(i,"isRejected",{get:()=>this.#r}),Object.defineProperty(i,"isCancelled",{get:()=>this.#e}),e(s,n,i)});}get[Symbol.toStringTag](){return "Cancellable Promise"}then(e,r){return this.#s.then(e,r)}catch(e){return this.#s.catch(e)}finally(e){return this.#s.finally(e)}cancel(){if(!(this.#t||this.#r||this.#e)){if(this.#e=!0,this.#o.length)try{for(let e of this.#o)e();}catch(e){console.warn("Cancellation threw an error",e);return}this.#o.length=0,this.#i?.(new N("Request aborted"));}}get isCancelled(){return this.#e}};var H=t=>t!=null,L=t=>typeof t=="string",k=t=>L(t)&&t!=="",G=t=>typeof t=="object"&&typeof t.type=="string"&&typeof t.stream=="function"&&typeof t.arrayBuffer=="function"&&typeof t.constructor=="function"&&typeof t.constructor.name=="string"&&/^(Blob|File)$/.test(t.constructor.name)&&/^(Blob|File)$/.test(t[Symbol.toStringTag]),X=t=>t instanceof P,Y=t=>t>=200&&t<300,ee=t=>{try{return btoa(t)}catch{return Buffer.from(t).toString("base64")}},te=t=>{let e=[],r=(s,n)=>{e.push(`${encodeURIComponent(s)}=${encodeURIComponent(String(n))}`);},o=(s,n)=>{H(n)&&(Array.isArray(n)?n.forEach(i=>{o(s,i);}):typeof n=="object"?Object.entries(n).forEach(([i,p])=>{o(`${s}[${i}]`,p);}):r(s,n));};return Object.entries(t).forEach(([s,n])=>{o(s,n);}),e.length>0?`?${e.join("&")}`:""},re=(t,e)=>{let r=t.ENCODE_PATH||encodeURI,o=e.url.replace("{api-version}",t.VERSION).replace(/{(.*?)}/g,(n,i)=>e.path?.hasOwnProperty(i)?r(String(e.path[i])):n),s=`${t.BASE}${o}`;return e.query?`${s}${te(e.query)}`:s},oe=t=>{if(t.formData){if(t.formData instanceof P)return t.formData;let e=new P,r=(o,s)=>{L(s)||G(s)?e.append(o,s):e.append(o,JSON.stringify(s));};return Object.entries(t.formData).filter(([o,s])=>H(s)).forEach(([o,s])=>{Array.isArray(s)?s.forEach(n=>r(o,n)):r(o,s);}),e}},D=async(t,e)=>typeof e=="function"?e(t):e,se=async(t,e,r)=>{let o=await D(e,t.TOKEN),s=await D(e,t.USERNAME),n=await D(e,t.PASSWORD),i=await D(e,t.HEADERS),p=r&&"getHeaders"in r&&typeof r?.getHeaders=="function"&&r?.getHeaders()||{},u=Object.entries({Accept:"application/json",...i,...e.headers,...p}).filter(([l,a])=>H(a)).reduce((l,[a,c])=>({...l,[a]:String(c)}),{});if(k(o)&&(u.Authorization=`Bearer ${o}`),k(s)&&k(n)){let l=ee(`${s}:${n}`);u.Authorization=`Basic ${l}`;}return e.body&&(e.mediaType?u["Content-Type"]=e.mediaType:G(e.body)?u["Content-Type"]=e.body.type||"application/octet-stream":L(e.body)?u["Content-Type"]="text/plain":X(e.body)||(u["Content-Type"]="application/json")),u},ie=t=>{if(t.body)return t.body},J=t=>!!($__default.default.isAxiosError(t)&&(t.response?.status&&[502,503,504].includes(t.response.status)||t.code&&["ECONNREFUSED","ECONNRESET","ENOTFOUND","ENETUNREACH",$.AxiosError.ECONNABORTED,$.AxiosError.ERR_NETWORK].includes(t.code))),ne=async(t,e,r,o,s,n,i,p)=>{let u=$__default.default.CancelToken.source(),l={url:r,headers:n,data:o??s,method:e.method,withCredentials:t.WITH_CREDENTIALS,cancelToken:u.token,responseType:e.responseType};i(()=>u.cancel("The user aborted a request."));try{return t.sindri?await Q__default.default(()=>p.request(l),{...t.sindri.retryOptions,onFailedAttempt:a=>{J(a)&&t.sindri.logger.debug({attemptNumber:a.attemptNumber,error:a.message,retriesLeft:a.retriesLeft},`${e.method} ${r} - Request failed, ${a.retriesLeft>0?"retrying":"aborting..."}...`);},shouldRetry:J}):await p.request(l)}catch(a){let c=a;if(c.response)return c.response;throw a}},ae=(t,e)=>{if(e){let r=t.headers[e];if(L(r))return r}},pe=t=>{if(t.status!==204)return t.data},le=(t,e)=>{let o={400:"Bad Request",401:"Unauthorized",403:"Forbidden",404:"Not Found",500:"Internal Server Error",502:"Bad Gateway",503:"Service Unavailable",...t.errors}[e.status];if(o)throw new I(t,e,o);if(!e.ok){let s=e.status??"unknown",n=e.statusText??"unknown",i=(()=>{try{return JSON.stringify(e.body,null,2)}catch{return}})();throw new I(t,e,`Generic Error: status: ${s}; status text: ${n}; body: ${i}`)}},z=(t,e,r=$__default.default)=>new A(async(o,s,n)=>{let i=Date.now(),p=()=>{let a=Date.now()-i;if(a<1e3)return `${a} ms`;let c=a/1e3;if(c<60)return `${c.toFixed(2)} s`;let g=c/60;return g<60?`${g.toFixed(2)} m`:`${(g/60).toFixed(2)} h`},u=re(t,e),l=`${e.method} ${u}`;try{let a=oe(e),c=ie(e),g=await se(t,e,a);if(!n.isCancelled){t.sindri?.logger.debug(`${l} requested`);let f=await ne(t,e,u,c,a,g,n,r),R=pe(f),d=ae(f,e.responseHeader),h={url:u,ok:Y(f.status),status:f.status,statusText:f.statusText,body:d??R},b=`${l} ${f.status} ${f.statusText} (${p()})`;!h.body||typeof h.body=="string"?t.sindri?.logger.debug(`${b} - ${h.body||"<empty-body>"}`):e.responseType==="stream"?t.sindri?.logger.debug(`${b} - <streaming-response>`):e.responseType==="blob"?t.sindri?.logger.debug(`${b} - <blob-response>`):t.sindri?.logger.debug(h.body,b),le(e,h),o(h.body);}}catch(a){let c=a instanceof Error?a.message:"Unknown error";t.sindri?.logger.debug(`${l} ERROR (${p()}) - ${c}`),s(a);}});var j=class extends S{constructor(e){super(e);}request(e){return z(this.config,e)}};var O=class{constructor(e){this.httpRequest=e;}apikeyGenerate(e){return this.httpRequest.request({method:"POST",url:"/api/apikey/generate",body:e,mediaType:"application/json",errors:{400:"Bad Request",401:"Unauthorized",403:"Forbidden"}})}apikeyGenerateWithAuth(e){return this.httpRequest.request({method:"POST",url:"/api/v1/apikey/generate",query:{name:e},errors:{400:"Bad Request"}})}apikeyList(){return this.httpRequest.request({method:"GET",url:"/api/v1/apikey/list",errors:{500:"Internal Server Error"}})}apikeyDelete(e){return this.httpRequest.request({method:"DELETE",url:"/api/v1/apikey/{apikey_id}/delete",path:{apikey_id:e},errors:{404:"Not Found",500:"Internal Server Error"}})}};var v=class{constructor(e){this.httpRequest=e;}circuitCreate(e){return this.httpRequest.request({method:"POST",url:"/api/v1/circuit/create",formData:e,mediaType:"multipart/form-data",errors:{400:"Bad Request",422:"Unprocessable Entity",500:"Internal Server Error",501:"Not Implemented"}})}circuitList(){return this.httpRequest.request({method:"GET",url:"/api/v1/circuit/list",errors:{500:"Internal Server Error"}})}circuitDetail(e,r=!0){return this.httpRequest.request({method:"GET",url:"/api/v1/circuit/{circuit_id}/detail",path:{circuit_id:e},query:{include_verification_key:r},errors:{404:"Not Found",500:"Internal Server Error"}})}circuitDelete(e){return this.httpRequest.request({method:"DELETE",url:"/api/v1/circuit/{circuit_id}/delete",path:{circuit_id:e},errors:{404:"Not Found",500:"Internal Server Error"}})}circuitProofs(e){return this.httpRequest.request({method:"GET",url:"/api/v1/circuit/{circuit_id}/proofs",path:{circuit_id:e},errors:{404:"Not Found",500:"Internal Server Error"}})}proofCreate(e,r){return this.httpRequest.request({method:"POST",url:"/api/v1/circuit/{circuit_id}/prove",path:{circuit_id:e},body:r,mediaType:"application/json",errors:{400:"Bad Request",404:"Not Found",409:"Conflict",501:"Not Implemented"}})}};var x=class{constructor(e){this.httpRequest=e;}circuitDownload(e,r){return this.httpRequest.request({method:"GET",url:"/api/v1/circuit/{circuit_id}/download",path:{circuit_id:e},query:{path:r},errors:{404:"Not Found",500:"Internal Server Error"},responseType:"blob"})}circuitProofsPaginated(e,r=100,o){return this.httpRequest.request({method:"GET",url:"/api/v1/circuit/{circuit_id}/proofs/paginated",path:{circuit_id:e},query:{limit:r,offset:o},errors:{404:"Not Found",500:"Internal Server Error"}})}projectCircuits(e){return this.httpRequest.request({method:"GET",url:"/api/v1/project/{project_id}/circuits",path:{project_id:e},errors:{404:"Not Found",500:"Internal Server Error"}})}projectCircuitsPaginated(e,r=100,o){return this.httpRequest.request({method:"GET",url:"/api/v1/project/{project_id}/circuits/paginated",path:{project_id:e},query:{limit:r,offset:o},errors:{404:"Not Found",500:"Internal Server Error"}})}projectDelete(e){return this.httpRequest.request({method:"DELETE",url:"/api/v1/project/{project_id}/delete",path:{project_id:e},errors:{404:"Not Found",500:"Internal Server Error"}})}projectDetail(e){return this.httpRequest.request({method:"GET",url:"/api/v1/project/{project_id}/detail",path:{project_id:e},errors:{404:"Not Found",500:"Internal Server Error"}})}projectList(e){return this.httpRequest.request({method:"POST",url:"/api/v1/project/list",body:e,mediaType:"application/json",errors:{404:"Not Found",500:"Internal Server Error"}})}projectListPaginated(e,r=100,o){return this.httpRequest.request({method:"POST",url:"/api/v1/project/list/paginated",query:{limit:r,offset:o},body:e,mediaType:"application/json",errors:{404:"Not Found",500:"Internal Server Error"}})}projectProofs(e){return this.httpRequest.request({method:"GET",url:"/api/v1/project/{project_id}/proofs",path:{project_id:e},errors:{404:"Not Found",500:"Internal Server Error"}})}projectProofsPaginated(e,r=100,o){return this.httpRequest.request({method:"GET",url:"/api/v1/project/{project_id}/proofs/paginated",path:{project_id:e},query:{limit:r,offset:o},errors:{404:"Not Found",500:"Internal Server Error"}})}projectSettings(e,r){return this.httpRequest.request({method:"POST",url:"/api/v1/project/{project_name}/settings",path:{project_name:e},body:r,mediaType:"application/json",errors:{404:"Not Found",422:"Unprocessable Entity",500:"Internal Server Error"}})}circuitSmartContractVerifier(e){return this.httpRequest.request({method:"GET",url:"/api/v1/circuit/{circuit_id}/smart_contract_verifier",path:{circuit_id:e},errors:{404:"Not Found",409:"Conflict",500:"Internal Server Error",501:"Not Implemented"}})}circuitStatus(e){return this.httpRequest.request({method:"GET",url:"/api/v1/circuit/{circuit_id}/status",path:{circuit_id:e},errors:{404:"Not Found",500:"Internal Server Error"}})}passwordChangeWithJwtAuth(e){return this.httpRequest.request({method:"POST",url:"/api/v1/password/change",body:e,mediaType:"application/json",errors:{422:"Unprocessable Entity"}})}proofList(e){return this.httpRequest.request({method:"POST",url:"/api/v1/proof/list",body:e,mediaType:"application/json",errors:{500:"Internal Server Error"}})}proofListPaginated(e,r=100,o){return this.httpRequest.request({method:"POST",url:"/api/v1/proof/list/paginated",query:{limit:r,offset:o},body:e,mediaType:"application/json",errors:{500:"Internal Server Error"}})}proofStatus(e){return this.httpRequest.request({method:"GET",url:"/api/v1/proof/{proof_id}/status",path:{proof_id:e},errors:{404:"Not Found",500:"Internal Server Error"}})}sindriManifestSchema(){return this.httpRequest.request({method:"GET",url:"/api/v1/sindri-manifest-schema.json"})}teamAvatarUpload(e){return this.httpRequest.request({method:"POST",url:"/api/v1/team/avatar/upload",formData:e,mediaType:"multipart/form-data",errors:{400:"Bad Request",500:"Internal Server Error"}})}teamDetail(e){return this.httpRequest.request({method:"GET",url:"/api/v1/team/{team_name}/detail",path:{team_name:e},errors:{404:"Not Found"}})}teamMe(){return this.httpRequest.request({method:"GET",url:"/api/v1/team/me"})}userMeWithJwtAuth(){return this.httpRequest.request({method:"GET",url:"/api/v1/user/me"})}};var q=class{constructor(e){this.httpRequest=e;}proofDetail(e,r=!0,o=!0,s=!0,n=!0){return this.httpRequest.request({method:"GET",url:"/api/v1/proof/{proof_id}/detail",path:{proof_id:e},query:{include_proof:r,include_public:o,include_smart_contract_calldata:s,include_verification_key:n},errors:{404:"Not Found",500:"Internal Server Error",501:"Not Implemented"}})}proofDelete(e){return this.httpRequest.request({method:"DELETE",url:"/api/v1/proof/{proof_id}/delete",path:{proof_id:e},errors:{404:"Not Found",500:"Internal Server Error"}})}};var w=class{constructor(e){this.httpRequest=e;}jwtTokenVerify(e){return this.httpRequest.request({method:"POST",url:"/api/token/verify",body:e,mediaType:"application/json"})}jwtTokenGenerate(e){return this.httpRequest.request({method:"POST",url:"/api/token/pair",body:e,mediaType:"application/json",errors:{403:"Forbidden"}})}jwtTokenRefresh(e){return this.httpRequest.request({method:"POST",url:"/api/token/refresh",body:e,mediaType:"application/json"})}};var _=class{authorization;circuits;internal;proofs;token;request;constructor(e,r=j){this.request=new r({BASE:e?.BASE??"https://sindri.app",VERSION:e?.VERSION??"1.12.21",WITH_CREDENTIALS:e?.WITH_CREDENTIALS??!1,CREDENTIALS:e?.CREDENTIALS??"include",TOKEN:e?.TOKEN,USERNAME:e?.USERNAME,PASSWORD:e?.PASSWORD,HEADERS:e?.HEADERS,ENCODE_PATH:e?.ENCODE_PATH}),this.authorization=new O(this.request),this.circuits=new v(this.request),this.internal=new x(this.request),this.proofs=new q(this.request),this.token=new w(this.request);}};var ue=zod.z.object({auth:zod.z.nullable(zod.z.object({apiKey:zod.z.string(),apiKeyId:zod.z.string(),apiKeyName:zod.z.string(),baseUrl:zod.z.string().url(),teamId:zod.z.number(),teamSlug:zod.z.string()})).default(null)});ue.parse({});var M=t=>{let e=ce__default.default({browser:{asObject:!0}});return e.level=t??!0?"silent":"info",e};M();var C=null;function me({cache:t=!0,logger:e,raiseExceptions:r=!1}={}){if(t&&C)return C;return C={};}function U(t){let e=me({raiseExceptions:!0});return Object.entries(t).forEach(([r,o])=>{let s=V(r,o);if(s)throw new Error(s)}),{...e,...t}}function V(t,e){let i=/^[a-zA-Z][a-zA-Z0-9_-]*$/;return t.length<1||t.length>64?`Invalid metadata key length for '${t}' (must be 1-64 characters).`:i.test(t)?e.length<0||e.length>4096?`Invalid metadata value length for '${t}' (must be 0-4096 characters).`:null:`Invalid metadata key for '${t}' (must start with an alphabet character and only include alphanumeric characters, underscores, and hyphens).`}var F=class t{_client;_clientConfig;_config;logger;pollingInterval=1e3;retryOptions={minTimeout:1e3,retries:6};constructor(e={},{retryOptions:r}={}){this._client=new _,this._clientConfig=this._client.request.config;let o="v0.0.1-alpha.61";this._clientConfig.HEADERS={...this._clientConfig.HEADERS,"Sindri-Client":`sindri-js-sdk/${o}`},this.logger=M(),this._clientConfig.sindri=this,this.authorize(e),r&&(this.retryOptions=structuredClone(r));}get apiKey(){return this._clientConfig.TOKEN&&typeof this._clientConfig.TOKEN!="string"?null:this._clientConfig.TOKEN||null}get baseUrl(){return this._clientConfig.BASE}get logLevel(){return this.logger.level}set logLevel(e){this.logger.level=e,this.logger.debug(`Set log level to "${this.logger.level}".`);}authorize(e){return this._clientConfig.BASE=e.baseUrl||"https://sindri.app",this._clientConfig.TOKEN=e.apiKey,!!(this._clientConfig.BASE&&this._clientConfig.TOKEN)}create(e,r){return new t(e,r)}async createCircuit(e,r=["latest"],o={}){let s=new P;r=typeof r=="string"?[r]:r??[];for(let l of r){if(!/^[-a-zA-Z0-9_.]+$/.test(l))throw new Error(`"${l}" is not a valid tag. Tags may only contain alphanumeric characters, underscores, hyphens, and periods.`);s.append("tags",l);}if(r.length===0&&s.append("tags",""),s.append("meta",JSON.stringify(U(o))),typeof e=="string"){throw new Error("Specifying `project` as a path is not allowed in the browser build.");}else if(Array.isArray(e)){if(!e.every(d=>d instanceof T))throw new Error("All entries in `project` must be `File` instances.");let l=e.find(d=>d.name==="sindri.json");if(!l)throw new Error("The `project` array must include a `sindri.json` file.");let a;try{a=JSON.parse(await l.text());}catch{throw new Error('Could not parse "sindri.json", is it valid JSON?')}let c=a?.name;if(!c)throw new Error('No circuit "name" field was found in "sindri.json", the manifest is invalid.');let g=new ye__default.default;e.sort((d,h)=>d.name.localeCompare(h.name));for(let d of e){let h=new Uint8Array(await d.arrayBuffer());await new Promise(b=>g.append(`${c}/${d.name}`,h,b));}let f=new Uint8Array(de__default.default.zip(g.out)),R=new T([f],`${c}.tar.gz`);s.append("files",R);}let n=this._clientConfig.HEADERS;this._clientConfig.HEADERS={...n,"Content-Type":"multipart/form-data; boundary=----WebKitFormBoundary0buQ8d6EhWcs9X9d"};let p=await this._client.circuits.circuitCreate(s);this._clientConfig.HEADERS=n;let u=p.circuit_id;for(;;){let l=await this._client.internal.circuitStatus(u);if(l.status==="Ready"||l.status==="Failed")break;await new Promise(a=>setTimeout(a,this.pollingInterval));}return this._client.circuits.circuitDetail(u,!1)}async getAllCircuitProofs(e){return await this._client.circuits.circuitProofs(e)}async getAllCircuits(){return await this._client.circuits.circuitList()}async getCircuit(e){return await this._client.circuits.circuitDetail(e)}async getProof(e){return await this._client.proofs.proofDetail(e)}async proveCircuit(e,r,o=!1,s=!1,n={}){let p=(await this._client.circuits.proofCreate(e,{meta:U(n),perform_verify:o,proof_input:r})).proof_id;for(;;){let u=await this._client.internal.proofStatus(p);if(u.status==="Ready"||u.status==="Failed")break;await new Promise(l=>setTimeout(l,this.pollingInterval));}return this._client.proofs.proofDetail(p,!0,!0,s,!0)}};var Yt=new F;

module.exports = Yt;
//# sourceMappingURL=out.js.map
//# sourceMappingURL=index.js.map